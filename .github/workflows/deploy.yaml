name: deploy

on:
  push:
    branches: ["main"]

env:
  DOCKER_REGISTRY: brenesrm
  IMAGE_NAME: rest_api

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout del c√≥digo fuente
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. Build the Docker image with build args
    - name: Build Docker image
      run: |
        docker build \
          --build-arg APP_ENV=${{ secrets.APP_ENV }} \
          -t $DOCKER_REGISTRY/${{ env.IMAGE_NAME }}:latest .

    # 4. Push the Docker image to Docker Hub
    - name: Push Docker image
      run: |
        docker push $DOCKER_REGISTRY/${{ env.IMAGE_NAME }}:latest
  test:
    name: Run tests
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run test
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm install
      - run: npm run test 